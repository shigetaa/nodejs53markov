# マルコフ連鎖で文章を要約する

形態素解析の一歩進んだ利用例として、マルコフ連鎖を使って要約などの文章を作成するプログラムを制作してみます。

## マルコフ連鎖とは
マルコフ連鎖とは、確率過程の一種です。
これは、ロシアの数学者マルコフによって研究されたもので、物理学や統計学の基本的なモデルに応用されています。

マルコフ性(Markov property)とは、「次の状態が過去の状態に依存せず、現在の状態のみによって決まる」という性質の事を言います。

これを利用すると、仕組みが単純でありながら、面白い文章を生成してくれます。
そのため、要約のほかに、文章の自動生成にも利用されることが多いようです。

作文の仕組みを箇条書きすると以下の様になります。

1. 文章を単語に分解(形態素解析)する
2. 単語の前後の結びつきを辞書に登録する
3. 辞書を利用してランダムに作文する

辞書の作り方にちょっと特徴があり、分かち書きした文章を、前後の結びつきで登録していきます。
例えば、「彼のネコは可愛い」という文章ならば、「彼,の,ネコ,は,可愛い」と文章を分割します。
そして、これを単語の前後に注目して、3要素ごとに辞書に登録していきます。

辞書は次のように登録していきます。

`彼` , `の` , `ネコ`

`の` , `ネコ` ,`は`

`は` , `可愛い`

この様に、辞書を元にして同じ組み合わせを持つ単語と単語をランダムに組み合わせると、別府ショウガ出来上がると言う仕組みです。
ただし、前後の単語の関連性が薄く、また意味を考えて文章を作るわけではないので組み合わせによっては、でたらめな文章になることもあります。

### マルコフ連鎖の実装
マルコフ連鎖の実装プログラムについて
今回は、辞書の生成に関して、JavaScript の Object を利用しています。
そのため大きな文章を読み込ませる、メモリー不足でエラーになってしまします。
今回は簡単にプログラムを作成する為、辞書データをデータベースを使用しませんが上記の事があるので通常はデータベースを利用した方がいいです。

では実際に`markov.js`と言うプログラムを作成していきます。

```javascript
var SENTENCE_COUNT = 3; // 3文作文する
var Mecab = require('./mecab-mod.js');
var mecab = new Mecab();
var fs = require('fs');

// 文章ファイルを読む
var text = fs.readFileSync("text.txt", "utf-8");
// 形態素解析して作文する
mecab.parse(text, function (err, items) {
	var dic = makeDic(items);
	makeSentence(dic);
});

// マルコフ連鎖用辞書の作成
function makeDic(items) {
	var tmp = ["@"];
	var dic = {};
	for (var i in items) {
		var t = items[i];
		var word = t[0];
		word = word.replace(/\s*/, '');
		if (word == "" || word == "EOS") continue;
		tmp.push(word);
		if (tmp.length < 3) continue;
		if (tmp.length > 3) tmp.splice(0, 1);
		setWord3(dic, tmp);
		if (word == "。") {
			tmp = ["@"];
			continue;
		}
	}
	return dic;
}
function setWord3(p, s3) {
	var w1 = s3[0], w2 = s3[1], w3 = s3[2];
	if (p[w1] == undefined) p[w1] = {};
	if (p[w1][w2] == undefined) p[w1][w2] = {};
	if (p[w1][w2][w3] == undefined) p[w1][w2][w3] = 0;
	p[w1][w2][w3]++;
}

// 辞書を元に作文を行う
function makeSentence(dic) {
	for (var i = 0; i < SENTENCE_COUNT; i++) {
		var ret = [];
		var top = dic["@"];
		if (!top) continue;
		var w1 = choiceWord(top);
		var w2 = choiceWord(top[w1]);
		ret.push(w1);
		ret.push(w2);
		for (; ;) {
			var w3 = choiceWord(dic[w1][w2]);
			ret.push(w3);
			if (w3 == "。") break;
			w1 = w2, w2 = w3;
		}
		console.log(ret.join(""));
	}
}
// キーの一覧を作成
function objKeys(obj) {
	var r = [];
	for (var i in obj) {
		r.push(i);
	}
	return r;
}
// キーの一覧から適当なものを選ぶ
function choiceWord(obj) {
	var ks = objKeys(obj);
	var i = rnd(ks.length);
	return ks[i];
}
function rnd(num) {
	return Math.floor(Math.random() * num);
}
```
上記のプログラムで使用するモジュール`mecab-mod.js`と動作に必要な環境については下記のMeCabについてを参照してください。

[MeCabについて<br>https://github.com/shigetaa/nodejs52mecab](https://github.com/shigetaa/nodejs52mecab)

本ブログラムで使用する、文章データ`text.txt`は夏目漱石の「こころ」の一部を下記の様に記述します。

```txt
私はその人を常に先生と呼んでいた。だからここでもただ先生と書くだけで本名は打ち明けない。これは世間を憚かる遠慮というよりも、その方が私にとって自然だからである。私はその人の記憶を呼び起すごとに、すぐ「先生」といいたくなる。筆を執っても心持は同じ事である。よそよそしい頭文字などはとても使う気にならない。
私が先生と知り合いになったのは鎌倉である。その時私はまだ若々しい書生であった。暑中休暇を利用して海水浴に行った友達からぜひ来いという端書を受け取ったので、私は多少の金を工面して、出掛ける事にした。私は金の工面に二、三日を費やした。ところが私が鎌倉に着いて三日と経たないうちに、私を呼び寄せた友達は、急に国元から帰れという電報を受け取った。電報には母が病気だからと断ってあったけれども友達はそれを信じなかった。友達はかねてから国元にいる親たちに勧まない結婚を強いられていた。彼は現代の習慣からいうと結婚するにはあまり年が若過ぎた。それに肝心の当人が気に入らなかった。それで夏休みに当然帰るべきところを、わざと避けて東京の近くで遊んでいたのである。彼は電報を私に見せてどうしようと相談をした。私にはどうしていいか分らなかった。けれども実際彼の母が病気であるとすれば彼は固より帰るべきはずであった。それで彼はとうとう帰る事になった。せっかく来た私は一人取り残された。
学校の授業が始まるにはまだ大分日数があるので鎌倉におってもよし、帰ってもよいという境遇にいた私は、当分元の宿に留まる覚悟をした。友達は中国のある資産家の息子で金に不自由のない男であったけれども、学校が学校なのと年が年なので、生活の程度は私とそう変りもしなかった。したがって一人ぼっちになった私は別に恰好な宿を探す面倒ももたなかったのである。
宿は鎌倉でも辺鄙な方角にあった。玉突きだのアイスクリームだのというハイカラなものには長い畷を一つ越さなければ手が届かなかった。車で行っても二十銭は取られた。けれども個人の別荘はそこここにいくつでも建てられていた。それに海へはごく近いので海水浴をやるには至極便利な地位を占めていた。
私は毎日海へはいりに出掛けた。古い燻ぶり返った藁葺の間を通り抜けて磯へ下りると、この辺にこれほどの都会人種が住んでいるかと思うほど、避暑に来た男や女で砂の上が動いていた。ある時は海の中が銭湯のように黒い頭でごちゃごちゃしている事もあった。その中に知った人を一人ももたない私も、こういう賑やかな景色の中に裹まれて、砂の上に寝そべってみたり、膝頭を波に打たしてそこいらを跳ね廻るのは愉快であった。
私は実に先生をこの雑沓の間に見付け出したのである。その時海岸には掛茶屋が二軒あった。私はふとした機会からその一軒の方に行き慣れていた。長谷辺に大きな別荘を構えている人と違って、各自に専有の着換場を拵えていないここいらの避暑客には、ぜひともこうした共同着換所といった風なものが必要なのであった。彼らはここで茶を飲み、ここで休息する外に、ここで海水着を洗濯させたり、ここで鹹はゆい身体を清めたり、ここへ帽子や傘を預けたりするのである。海水着を持たない私にも持物を盗まれる恐れはあったので、私は海へはいるたびにその茶屋へ一切を脱ぎ棄てる事にしていた。
```

実行するには、以下のコマンドを実行します。
```bash
node markov.js
```
```bash
古い燻ぶり返った藁葺の間に見付け出したのは鎌倉でも辺鄙な方角にあったけれども友達は、ぜひともこうした共同着換所といった風なものにはどうしていいか分らなかった。
暑中休暇を利用している人と違って、各自に専有の着換場を拵えていないここいらの避暑客には掛茶屋が二軒あったけれども友達はそれを信じなかった。
せっかく来た男や女で砂の上が動いていないここいらの避暑客には母が病気である。
```
とか
```bash
だからここでもただ先生と書くだけで本名は打ち明けない。
車で行っても二十銭は取られた。
電報には掛茶屋が二軒あったので、私はまだ若々しい書生であった。
```
上記の様に実行する度に、表示する文章がランダムに変わります。